<!DOCTYPE html>
<html lang="en">

<head>
    <title>Choropleth Mapping</title>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
    <!-- Slogan -->
    <div class="fullwidth-column">
        <h1>Choropleth Mapping</h1>
    </div>

    <!-- Whole View -->
    <div class="fullwidth-column">
        <h2>Whole View</h2>
        <p>The whole map plotting</p>
        <div id="Div-1"></div>
    </div>

    <!-- Split View -->
    <div class="fullwidth-column">
        <h2>Split View</h2>
        <p>The splits of the maps</p>
        <div id="Div-2" class="flex-display"></div>
    </div>

    <script type="text/javascript" src="{{workingDir}}/rewind.js"></script>
    <script type="text/javascript">
        // Overall settings
        // Adjust the precision to lower the computation level
        let precision = 20

        let width = 600;
        let height = 400;
        let svg = d3
            .select("#Div-1")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
        url = 'choroplethMaps/100000_full.json'
        drawMap(url, svg, true)

        function randomColor() {
            let h = parseInt(Math.random() * 360),
                s = 0.5,
                l = 0.5;
            return d3.hsl(h, s, l).toString();
        }

        function drawMap(url, svg, iter) {
            // Draw choropleth mas on 'svg'
            // The geoJson is requested from 'url'
            console.log('Drawing map of', url);


            d3.json(url).then(function (geoJson) {
                geojsonRewind(geoJson, true)
                console.log(url, geoJson)

                let features = geoJson.features;
                let center = features[0].properties.center;

                var projection = d3
                    .geoAzimuthalEqualArea()
                    .rotate([-center[0], -center[1], 0])
                    .fitSize([svg.attr('width'), svg.attr('height')], geoJson)
                    .precision(precision);

                let path = d3.geoPath(projection);

                svg
                    .selectAll("path")
                    .data(features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", function (d) {
                        if (iter) {
                            let u = 'choroplethMaps/' + d.properties.adcode + '_full.json'
                            let w = 100
                            let h = 100
                            let div = d3.select("#Div-2").append('div')
                            div.append('p').text(d.properties.name)
                            let s = div.append('svg').attr('width', w).attr('height', h)
                            drawMap(u, s, false)
                        }
                        return randomColor()
                    })
                    .style("stroke", "gray")
                    .attr("class", "Province")
                    .attr("id", (d) => d.properties.adcode);

                console.log(document.getElementsByClassName("Province"));
            })
        }
    </script>
</body>

</html>